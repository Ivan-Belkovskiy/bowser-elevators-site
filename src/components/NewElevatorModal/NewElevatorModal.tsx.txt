'use client';
import { ChangeEvent, useState } from "react";
import "./NewElevatorModal.css";
import { AccessCondition, FloorConfig } from "@/types/data/FloorTypes";
import ModalWrapper from "../ModalWrapper/ModalWrapper";
import VideoSettingsModal from "../VideoSettingsModal/VideoSettingsModal";
import { VideoSettingsModalProps } from "@/types/components/VideoSettingsModal/VideoSettingsModal";
import { VideoData } from "@/types/data/VideoData";
import { EVPSoundEffects, EVPMovementSoundEffects } from "@/types/data/ElevatorVideoPlayer/ElevatorVideoPlayer";
import SwitchCheckbox from "../SwitchCheckbox/SwitchCheckbox";
import FileUploader from "../FileUploader/FileUploader";
export default function NewElevatorModal() {
    const [openedModal, setOpenedModal] = useState<VideoSettingsModalProps | null>(null);
    const [floors, setFloors] = useState<FloorConfig[]>([]);
    const [elevatorName, setElevatorName] = useState<string>('');
    const [elevatorDescription, setElevatorDescription] = useState<string>('');
    const [soundEffects, setSoundEffects] = useState<EVPSoundEffects>({});

    const [withCoursebot, setWithCoursebot] = useState<boolean>(true);

    const uploadSoundFile = (e: ChangeEvent<HTMLInputElement>, categoryOrSound: string, subcategory?: keyof EVPMovementSoundEffects) => {
        const file = e.target.files?.[0];
        if (!file) return;
        // alert(file instanceof File);
        if (categoryOrSound === 'movement' && subcategory) updateSoundEffects(categoryOrSound, {
            [subcategory]: file
        }); else updateSoundEffects(categoryOrSound, file);
    }

    const updateSoundEffects = (property: string, data: File | Partial<EVPMovementSoundEffects>) => {
        if (data instanceof File) setSoundEffects({
            ...soundEffects,
            [property]: data,
        }); else if (property === 'movement') setSoundEffects({
            ...soundEffects,
            [property]: {
                ...soundEffects[property],
                ...data,
            }
        });
    }

    const addFloor = () => {
        const newFloor: FloorConfig = {
            // floorNumber: (floors.length + 1),
            displaySymbol: String(floors.length + 1),
            accessCondition: { type: 'free' },
            videoData: {
                title: '',
                url: '',
            }, // No video
        };
        setFloors([...floors, newFloor]);
    }
    const updateFloor = (prop: string, value: any, index: number) => {
        setFloors(prevFloors => prevFloors.map((floor, idx) => idx === index ? {
            ...floor,
            [prop]: value,
        } : floor));
    }

    const updateAccessCondition = (floorIdx: number, value: Partial<AccessCondition>) => {
        const current = floors[floorIdx].accessCondition;
        updateFloor('accessCondition', {
            ...current,
            ...value,
        }, floorIdx);
    }

    const updateVideoData = (floorIdx: number, value: Partial<VideoData>) => {
        const current = floors[floorIdx].videoData;
        // alert(JSON.stringify(current, null, 3));
        updateFloor('videoData', {
            ...current,
            ...value,
        }, floorIdx);
        setOpenedModal({
            floor: floors[floorIdx],
            idx: floorIdx,
            updateVideoData,
            onClose: () => setOpenedModal(null),
        });
    }

    const removeFloor = (floorIdx: number) => {
        if (floors.length > 1) setFloors(prev => prev.filter((floor, idx) => idx !== floorIdx && floor));
    }

    const openVideoSettingsModal = (props: VideoSettingsModalProps) => {
        setOpenedModal(props);
    }

    const createElevator = () => {
        alert('Лифт Создан!!!');
        const elevatorObj = {
            name: elevatorName,
            description: elevatorDescription,
            floorList: floors,
            soundEffects: soundEffects,
            coursebotEnabled: withCoursebot,
        };
        console.log(elevatorObj);
    }

    return (
        <div className="new-elevator-modal">
            <div className="new-elevator-modal__container">
                <h1 className="new-elevator-modal__title">Новый Лифт</h1>
                <div className="new-elevator-modal__content">
                    <div className="new-elevator-modal__item">
                        <span className="new-elevator-modal__label">Название и описание</span>
                        <div className="new-elevator-modal__item-content">
                            <div className="new-elevator-modal__block">
                                <span className="new-elevator-modal__text">Название:</span>
                                <input
                                    type="text"
                                    className="new-elevator-modal__input name-description-input"
                                    value={elevatorName}
                                    onChange={(e) => setElevatorName(e.target.value)}
                                />
                            </div>
                            <div className="new-elevator-modal__block">
                                <span className="new-elevator-modal__text">Описание:</span>
                                <textarea
                                    className="new-elevator-modal__input name-description-input"
                                    value={elevatorDescription}
                                    onChange={(e) => setElevatorDescription(e.target.value)}
                                ></textarea>
                            </div>
                        </div>
                    </div>
                    <div className="new-elevator-modal__item">
                        <span className="new-elevator-modal__label">Этажи лифта</span>
                        <div className="new-elevator-modal__item-content">
                            <div className="new-elevator-modal__block flex-col floor-list">
                                {floors.map((floor, idx) => (
                                    <div className="new-elevator-modal__floor-block" key={idx}>
                                        <div className="new-elevator-modal__floor-block-left">
                                            <div className="new-elevator-modal__floor-tile">{(idx + 1)}F</div>
                                            <div className="new-elevator-modal__floor-tile">
                                                <span className="new-elevator-modal__floor-text">Отобразить как:</span>
                                                <input type="text" className="new-elevator-modal__input floor-symbol-input" onChange={(e) => updateFloor("displaySymbol", e.target.value, idx)} value={floor.displaySymbol} />
                                            </div>
                                            <div className="new-elevator-modal__floor-tile">
                                                <span className="new-elevator-modal__floor-text">Доступность:</span>
                                                <select
                                                    className="new-elevator-modal__input floor-access-select"
                                                    value={floor.accessCondition?.type || 'free'}
                                                    onChange={(e) => updateFloor("accessCondition", { type: e.target.value }, idx)}
                                                >
                                                    <option value="free">всегда</option>
                                                    <option value="viewCount">после просмотра видео</option>
                                                    <option value="blocked">заблокирован</option>
                                                </select>
                                                {floor.accessCondition?.type === 'viewCount' && (
                                                    <>
                                                        <input
                                                            type="number"
                                                            min={1}
                                                            max={9}
                                                            className="new-elevator-modal__input floor-view-count-input"
                                                            value={floor.accessCondition?.requiredViews || 1}
                                                            onChange={(e) => updateAccessCondition(idx, { requiredViews: Number(e.target.value) })}

                                                        />
                                                        <span className="new-elevator-modal__text ml-1">раз{([2, 3, 4].includes(Number(floor.accessCondition?.requiredViews || 1))) && 'а'} на</span>
                                                        <select
                                                            className="new-elevator-modal__input floor-number-select"
                                                            value={floor.accessCondition?.floor}
                                                            onChange={(e) => updateAccessCondition(idx, { floor: Number(e.target.value) })}
                                                        >
                                                            {floors.map((floor, i) => (i !== idx) && <option key={i} value={(idx + 1)}>{(idx + 1)}F</option>)}
                                                        </select>

                                                    </>
                                                )}
                                            </div>
                                            <div className="new-elevator-modal__floor-tile">
                                                <button
                                                    className="new-elevator-modal__button floor-video-button"
                                                    onClick={() => openVideoSettingsModal({
                                                        floor: floors[idx],
                                                        idx,
                                                        updateVideoData,
                                                        onClose: () => setOpenedModal(null),
                                                    })}>
                                                    <span>Видео {(floor.videoData?.title && floor.videoData.title.length < 34) && <span className="small-text">
                                                        ({floor.videoData?.title})
                                                    </span>}...</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div className="new-elevator-modal__floor-block-right">
                                            {floors.length > 1 && <div className="new-elevator-modal__floor-tile">
                                                <button className="new-elevator-modal__button remove-floor-button" onClick={() => removeFloor(idx)}>
                                                    <span>×</span>
                                                </button>
                                            </div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="new-elevator-modal__block">
                                <button className="new-elevator-modal__button add-floor-button" onClick={addFloor}>+ Новый этаж</button>
                            </div>
                        </div>
                    </div>
                    <div className="new-elevator-modal__item">
                        <span className="new-elevator-modal__label">Звуковые эффекты</span>
                        <div className="new-elevator-modal__item-content">
                            <div className="new-elevator-modal__block sound-effect-block">
                                <span>Открытие дверей ::</span>
                                <FileUploader
                                    btnClass="new-elevator-modal__button upload-sound-button"
                                    label="Загрузить аудиофайл..."
                                    onUpload={(e) => uploadSoundFile(e, "doorOpen")}
                                    file={soundEffects.doorOpen}
                                    msgClass="new-elevator-modal__message uploaded-sound-name"
                                    accept="audio/*"
                                />
                            </div>
                            <div className="new-elevator-modal__block sound-effect-block">
                                <span>Закрытие дверей ::</span>
                                <FileUploader
                                    btnClass="new-elevator-modal__button upload-sound-button"
                                    label="Загрузить аудиофайл..."
                                    onUpload={(e) => uploadSoundFile(e, "doorClose")}
                                    file={soundEffects.doorClose}
                                    msgClass="new-elevator-modal__message uploaded-sound-name"
                                    accept="audio/*"
                                />
                            </div>
                            <div className="new-elevator-modal__block sound-effect-block">
                                <span>Нажатие на кнопку ::</span>
                                <FileUploader
                                    btnClass="new-elevator-modal__button upload-sound-button"
                                    label="Загрузить аудиофайл..."
                                    onUpload={(e) => uploadSoundFile(e, "buttonClick")}
                                    file={soundEffects.buttonClick}
                                    msgClass="new-elevator-modal__message uploaded-sound-name"
                                    accept="audio/*"
                                />
                            </div>
                            <div className="new-elevator-modal__block sound-effect-block">
                                <span>Начало движения лифта ::</span>
                                <FileUploader
                                    btnClass="new-elevator-modal__button upload-sound-button"
                                    label="Загрузить аудиофайл..."
                                    onUpload={(e) => uploadSoundFile(e, "movement", "start")}
                                    file={soundEffects.movement?.start}
                                    msgClass="new-elevator-modal__message uploaded-sound-name"
                                    accept="audio/*"
                                />
                            </div>
                            <div className="new-elevator-modal__block sound-effect-block">
                                <span>Движение лифта ::</span>
                                <FileUploader
                                    btnClass="new-elevator-modal__button upload-sound-button"
                                    label="Загрузить аудиофайл..."
                                    onUpload={(e) => uploadSoundFile(e, "movement", "move")}
                                    file={soundEffects.movement?.move}
                                    msgClass="new-elevator-modal__message uploaded-sound-name"
                                    accept="audio/*"
                                />
                            </div>
                            <div className="new-elevator-modal__block sound-effect-block">
                                <span>Остановка лифта ::</span>
                                <FileUploader
                                    btnClass="new-elevator-modal__button upload-sound-button"
                                    label="Загрузить аудиофайл..."
                                    onUpload={(e) => uploadSoundFile(e, "movement", "end")}
                                    file={soundEffects.movement?.end}
                                    msgClass="new-elevator-modal__message uploaded-sound-name"
                                    accept="audio/*"
                                />
                            </div>
                        </div>
                    </div>
                    <div className="new-elevator-modal__item">
                        <span className="new-elevator-modal__label">Уровнебот</span>
                        <div className="new-elevator-modal__item-content">
                            <div className="new-elevator-modal__block">
                                <span className="new-elevator-modal__text coursebot-span">Включить Уровнебот:</span>
                                <SwitchCheckbox value={withCoursebot} text={['ВКЛ.', 'ВЫКЛ.']} onChange={setWithCoursebot} />
                            </div>
                            {/* {(withCoursebot) ? <p>Уровнебот включен!</p> : <p>Уровнебот отключен!</p>} */}
                        </div>
                    </div>
                    <button className="new-elevator-modal__button create-elevator-button" onClick={createElevator}>Создать Лифт</button>
                </div>
            </div>
            <ModalWrapper>
                {openedModal && <VideoSettingsModal
                    floor={floors[openedModal.idx]}
                    idx={openedModal.idx}
                    updateVideoData={updateVideoData}
                    onClose={() => setOpenedModal(null)}
                />}
            </ModalWrapper>
        </div>
    );
}